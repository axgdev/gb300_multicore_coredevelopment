#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include "helloworld.h"

#define SCREEN_WIDTH 320
#define SCREEN_HEIGHT 240
#define FONT_WIDTH 8
#define FONT_HEIGHT 8

static uint16_t framebuffer[SCREEN_WIDTH * SCREEN_HEIGHT];

static retro_environment_t environ_cb;
static retro_video_refresh_t video_cb;
static retro_input_poll_t input_poll_cb;
static retro_input_state_t input_state_cb;
static retro_audio_sample_t audio_cb;
static retro_audio_sample_batch_t audio_batch_cb;

// Simple 8x8 font
static const uint8_t font8x8_basic[128][8] = {
    // ASCII 32-127 characters
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space
    {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // !
    {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00}, // #
    {0x0C, 0x7E, 0x36, 0x1C, 0x36, 0x7E, 0x0C, 0x00}, // $
    {0x6C, 0x6C, 0x1E, 0x06, 0x0C, 0x38, 0x30, 0x00}, // %
    {0x1E, 0x36, 0x36, 0x1E, 0x36, 0x36, 0x1E, 0x00}, // &
    {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    {0x1C, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // (
    {0x36, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // )
    {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}, // *
    {0x00, 0x0C, 0x0C, 0x3E, 0x0C, 0x0C, 0x00, 0x00}, // +
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x36, 0x00}, // ,
    {0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x00}, // -
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00}, // .
    {0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00}, // /
    {0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00}, // 0
    {0x0C, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3E, 0x00}, // 1
    {0x3E, 0x63, 0x03, 0x1E, 0x60, 0x60, 0x7F, 0x00}, // 2
    {0x3E, 0x63, 0x03, 0x1E, 0x03, 0x63, 0x3E, 0x00}, // 3
    {0x60, 0x60, 0x60, 0x1E, 0x03, 0x03, 0x7F, 0x00}, // 4
    {0x7F, 0x60, 0x60, 0x3E, 0x03, 0x63, 0x3E, 0x00}, // 5
    {0x3E, 0x63, 0x60, 0x3E, 0x63, 0x63, 0x3E, 0x00}, // 6
    {0x7F, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00}, // 7
    {0x3E, 0x63, 0x63, 0x3E, 0x63, 0x63, 0x3E, 0x00}, // 8
    {0x3E, 0x63, 0x63, 0x3F, 0x03, 0x63, 0x3E, 0x00}, // 9
    {0x00, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x00}, // :
    {0x00, 0x06, 0x06, 0x00, 0x00, 0x36, 0x36, 0x00}, // ;
    {0x18, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00}, // <
    {0x00, 0x3E, 0x00, 0x00, 0x00, 0x3E, 0x00, 0x00}, // =
    {0x63, 0x36, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, // >
    {0x3E, 0x63, 0x04, 0x08, 0x10, 0x00, 0x10, 0x00}, // ?
    {0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x3E, 0x00}, // @
    {0x7E, 0x09, 0x09, 0x09, 0x1D, 0x36, 0x63, 0x00}, // A
    {0x7F, 0x63, 0x63, 0x3E, 0x63, 0x63, 0x7F, 0x00}, // B
    {0x3E, 0x63, 0x60, 0x60, 0x60, 0x63, 0x3E, 0x00}, // C
    {0x7F, 0x60, 0x60, 0x3E, 0x60, 0x60, 0x7F, 0x00}, // D
    {0x7F, 0x63, 0x60, 0x3E, 0x60, 0x63, 0x7F, 0x00}, // E
    {0x7F, 0x03, 0x00, 0x1E, 0x00, 0x03, 0x7F, 0x00}, // F
    {0x3E, 0x63, 0x60, 0x7B, 0x63, 0x63, 0x3E, 0x00}, // G
    {0x7F, 0x06, 0x06, 0x3E, 0x06, 0x06, 0x7F, 0x00}, // H
    {0x60, 0x60, 0x60, 0x7F, 0x60, 0x60, 0x60, 0x00}, // I
    {0x78, 0x60, 0x60, 0x7F, 0x60, 0x60, 0x60, 0x00}, // J
    {0x7F, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7F, 0x00}, // K
    {0x7F, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00}, // L
    {0x7F, 0x03, 0x06, 0x0C, 0x06, 0x03, 0x7F, 0x00}, // M
    {0x7F, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x7F, 0x00}, // N
    {0x3E, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00}, // O
    {0x7F, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00}, // P
    {0x3E, 0x63, 0x63, 0x63, 0x6B, 0x36, 0x6F, 0x00}, // Q
    {0x7F, 0x63, 0x63, 0x3E, 0x30, 0x60, 0x7F, 0x00}, // R
    {0x3E, 0x63, 0x60, 0x3E, 0x03, 0x63, 0x3E, 0x00}, // S
    {0x7F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}, // T
    {0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00}, // U
    {0x63, 0x63, 0x36, 0x1C, 0x1C, 0x00, 0x00, 0x00}, // V
    {0x63, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x63, 0x00}, // W
    {0x63, 0x36, 0x1C, 0x00, 0x1C, 0x36, 0x63, 0x00}, // X
    {0x63, 0x36, 0x1C, 0x0C, 0x0C, 0x00, 0x0C, 0x00}, // Y
    {0x7F, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x7F, 0x00}, // Z
    {0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // [
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // backslash
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x00}, // ]
    {0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00}, // ^
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // _
    {0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    {0x00, 0x1E, 0x33, 0x33, 0x33, 0x33, 0x3E, 0x00}, // a
    {0x7C, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x00, 0x00}, // b
    {0x3E, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3E, 0x00}, // c
    {0x3E, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x00, 0x00}, // d
    {0x3E, 0x63, 0x63, 0x3E, 0x60, 0x60, 0x00, 0x00}, // e
    {0x7E, 0x06, 0x00, 0x1E, 0x00, 0x06, 0x7E, 0x00}, // f
    {0x3E, 0x63, 0x63, 0x7B, 0x6F, 0x63, 0x3E, 0x00}, // g
    {0x7C, 0x06, 0x06, 0x3E, 0x06, 0x06, 0x7C, 0x00}, // h
    {0x30, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00}, // i
    {0x30, 0x00, 0x3E, 0x60, 0x60, 0x00, 0x00, 0x00}, // j
    {0x7C, 0x0C, 0x18, 0x30, 0x60, 0x0C, 0x7C, 0x00}, // k
    {0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // l
    {0x7C, 0x06, 0x0C, 0x06, 0x0C, 0x06, 0x7C, 0x00}, // m
    {0x7C, 0x06, 0x06, 0x06, 0x06, 0x06, 0x7C, 0x00}, // n
    {0x3E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00}, // o
    {0x7C, 0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00}, // p
    {0x3E, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x03, 0x00}, // q
    {0x7C, 0x66, 0x60, 0x30, 0x18, 0x0C, 0x7C, 0x00}, // r
    {0x3E, 0x63, 0x60, 0x3E, 0x03, 0x63, 0x3E, 0x00}, // s
    {0x7E, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00}, // t
    {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00}, // u
    {0x66, 0x66, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00}, // v
    {0x66, 0x66, 0x36, 0x1C, 0x36, 0x66, 0x66, 0x00}, // w
    {0x66, 0x36, 0x1C, 0x00, 0x1C, 0x36, 0x66, 0x00}, // x
    {0x66, 0x36, 0x1C, 0x0C, 0x0C, 0x00, 0x0C, 0x00}, // y
    {0x7F, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x7F, 0x00}, // z
    {0x36, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00}, // {
    {0x00, 0x7F, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00}, // |
    {0x6C, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00}, // }
    {0x0E, 0x1B, 0x04, 0x0A, 0x11, 0x00, 0x0E, 0x00}, // ~
    {0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x00}  // DEL
};

// Draw a character on the framebuffer
void draw_char(int x, int y, char c, uint16_t color) {
    if (x < 0 || y < 0 || x >= SCREEN_WIDTH - FONT_WIDTH || y >= SCREEN_HEIGHT - FONT_HEIGHT)
        return;

    if (c < 32 || c > 127)
        c = '?';

    for (int cy = 0; cy < FONT_HEIGHT; cy++) {
        uint8_t line = font8x8_basic[c - 32][cy];
        for (int cx = 0; cx < FONT_WIDTH; cx++) {
            if (line & (1 << (7 - cx))) {
                framebuffer[(y + cy) * SCREEN_WIDTH + (x + cx)] = color;
            }
        }
    }
}

// Draw a string on the framebuffer
void draw_text(int x, int y, const char* text, uint16_t color) {
    int px = x;
    while (*text) {
        draw_char(px, y, *text, color);
        px += FONT_WIDTH;
        text++;
    }
}

// Render our hello world message
void render_hello_world(void) {
    // Clear framebuffer to black
    memset(framebuffer, 0, sizeof(framebuffer));
    
    // Draw "hello world!" in the center of the screen
    const char* message = "hello world!";
    int text_width = strlen(message) * FONT_WIDTH;
    int x = (SCREEN_WIDTH - text_width) / 2;
    int y = (SCREEN_HEIGHT - FONT_HEIGHT) / 2;
    
    draw_text(x, y, message, 0xFFFF); // White text
}

void retro_init(void) {
    // Nothing to initialize
}

void retro_deinit(void) {
    // Nothing to clean up
}

unsigned retro_api_version(void) {
    return RETRO_API_VERSION;
}

void retro_set_controller_port_device(unsigned port, unsigned device) {
    // We don't use any input
}

void retro_get_system_info(struct retro_system_info *info) {
    memset(info, 0, sizeof(*info));
    info->library_name = "Hello World";
    info->library_version = "1.0";
    info->need_fullpath = false;
    info->valid_extensions = "";
}

void retro_get_system_av_info(struct retro_system_av_info *info) {
    info->timing.fps = 60.0;
    info->timing.sample_rate = 44100.0;

    info->geometry.base_width = SCREEN_WIDTH;
    info->geometry.base_height = SCREEN_HEIGHT;
    info->geometry.max_width = SCREEN_WIDTH;
    info->geometry.max_height = SCREEN_HEIGHT;
    info->geometry.aspect_ratio = (float)SCREEN_WIDTH / (float)SCREEN_HEIGHT;
}

void retro_set_environment(retro_environment_t cb) {
    environ_cb = cb;
    bool no_rom = true;
    cb(RETRO_ENVIRONMENT_SET_SUPPORT_NO_GAME, &no_rom);
}

void retro_set_audio_sample(retro_audio_sample_t cb) {
    audio_cb = cb;
}

void retro_set_audio_sample_batch(retro_audio_sample_batch_t cb) {
    audio_batch_cb = cb;
}

void retro_set_input_poll(retro_input_poll_t cb) {
    input_poll_cb = cb;
}

void retro_set_input_state(retro_input_state_t cb) {
    input_state_cb = cb;
}

void retro_set_video_refresh(retro_video_refresh_t cb) {
    video_cb = cb;
}

void retro_reset(void) {
    // Nothing to reset
}

void retro_run(void) {
    // Poll input even though we don't use it
    input_poll_cb();
    
    // Render our hello world
    render_hello_world();
    
    // Send framebuffer to frontend
    video_cb(framebuffer, SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_WIDTH * sizeof(uint16_t));
    
    // No audio in this core
    audio_batch_cb(NULL, 0);
}

size_t retro_serialize_size(void) {
    return 0; // We don't support save states
}

bool retro_serialize(void *data_, size_t size) {
    return false;
}

bool retro_unserialize(const void *data_, size_t size) {
    return false;
}

void retro_cheat_reset(void) {
    // No cheats
}

void retro_cheat_set(unsigned index, bool enabled, const char *code) {
    // No cheats
}

bool retro_load_game(const struct retro_game_info *info) {
    enum retro_pixel_format fmt = RETRO_PIXEL_FORMAT_RGB565;
    if (!environ_cb(RETRO_ENVIRONMENT_SET_PIXEL_FORMAT, &fmt)) {
        return false;
    }
    
    return true;
}

bool retro_load_game_special(unsigned type, const struct retro_game_info *info, size_t num) {
    return false;
}

void retro_unload_game(void) {
    // Nothing to unload
}

unsigned retro_get_region(void) {
    return RETRO_REGION_NTSC;
}

void* retro_get_memory_data(unsigned id) {
    return NULL;
}

size_t retro_get_memory_size(unsigned id) {
    return 0;
}